# Copyright Â© 2025 Brent Tunnicliff <brent@tunnicliff.dev>

name: Pipeline

on:
  push:
  workflow_dispatch:

env:
  PACKAGE_SCHEME: "REPLACE_ME"

jobs:
  test:
    runs-on: macos-26
    strategy:
      # Don't fail the other matrix values if one fails.
      fail-fast: false
      matrix:
        target: [
          { platform: "iOS", simulator_version: "26.1" },
          { platform: "tvOS", simulator_version: "26.1" },
          { platform: "watchOS", simulator_version: "26.1" },
          { platform: "visionOS", simulator_version: "26.1" },

          # macOS runs on the host and doesn't need a simulator.
          { platform: "macOS", simulator_version: "" }
        ]
    steps:
      # ---------------------------
      # Setup
      # ---------------------------

      - name: Setup pipeline
        id: setup
        uses: Brent-Tunnicliff/action-setup-apple@v1
        with:
          platform: "${{ matrix.target.platform }}"
          simulator_version: "${{ matrix.target.simulator_version }}"
          xcode_path: "/Applications/Xcode_26.1.app"

      # ---------------------------
      # Build and test package
      # ---------------------------

      - name: Build package debug
        env:
          DESTINATION: ${{ steps.setup.outputs.destination }}
        run: xcodebuild build
          -scheme "$PACKAGE_SCHEME"
          -destination "$DESTINATION"
          -configuration "Debug"
          -skipPackagePluginValidation
          CODE_SIGN_IDENTITY=""
          CODE_SIGNING_REQUIRED=NO

      - name: Build package tests
        env:
          DESTINATION: ${{ steps.setup.outputs.destination }}
        run: xcodebuild build-for-testing
          -scheme "$PACKAGE_SCHEME"
          -destination "$DESTINATION"
          -skipPackagePluginValidation
          CODE_SIGN_IDENTITY=""
          CODE_SIGNING_REQUIRED=NO

      - name: Run package tests
        env:
          DESTINATION: ${{ steps.setup.outputs.destination }}
          RESULTS_BUNDLE_PATH: ${{ steps.setup.outputs.test_results_path }}
        run: xcodebuild test-without-building
          -scheme "$PACKAGE_SCHEME"
          -destination "$DESTINATION"
          -resultBundlePath "$RESULTS_BUNDLE_PATH"
          CODE_SIGN_IDENTITY=""
          CODE_SIGNING_REQUIRED=NO

      - name: Upload test results
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: "${{ steps.setup.outputs.test_results_file_name }}"
          path: "${{ steps.setup.outputs.test_results_path }}"
          if-no-files-found: error

      # Lets make sure it also builds in release configuration in case there are conditionals.
      - name: Build package release
        env:
          DESTINATION: ${{ steps.setup.outputs.destination }}
        run: xcodebuild build
          -scheme "$PACKAGE_SCHEME"
          -destination "$DESTINATION"
          -configuration "Release"
          -skipPackagePluginValidation
          CODE_SIGN_IDENTITY=""
          CODE_SIGNING_REQUIRED=NO

      # ---------------------------
      # Final checks
      # ---------------------------

      # Make sure there are no local changes as any auto generated changes must be checked into git.
      - name: Check git status
        uses: Brent-Tunnicliff/action-git-status@v1
